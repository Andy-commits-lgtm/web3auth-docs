---
title: Using Web3Auth One Key Flow
image: "/docs/contents/guides/banners/one-key-flow.png"
description: Learn how to use Web3Auth One Key Flow to authenticate users with Firebase.
type: guide
tags: [web, one key flow, "@web3auth/core", custom authentication, react, ethereum]
date: 4th October 2022
author: Web3Auth Team
order: 2
---

import Tabs from "@theme/Tabs";
import TabItem from "@theme/TabItem";

import InitializationIntro from "@site/src/common/guides/_initialization-intro.mdx";
import InitializationWeb3Auth from "@site/src/common/guides/_initialization-web3auth.mdx";
import InstallationWithOneKeyFlowFirebase from "@site/src/common/guides/_installation-one-key-flow.mdx";
import InstantiationWeb3Auth from "@site/src/common/guides/_instantiation-web3auth.mdx";
import InteractingWithBlockchain from "@site/src/common/guides/_interacting-with-blockchain.mdx";
import OpenloginConfigCodeFirebase from "@site/src/common/guides/_openlogin-config-code-firebase.mdx";
import SetupBaseProject from "@site/src/common/guides/_setup-base-project.mdx";
import SetupWeb3AuthDashboard from "@site/src/common/guides/_setup-web3auth-dashboard.mdx";
import Web3AuthPrerequisites from "@site/src/common/guides/_web3auth-prerequisites.mdx";
import SEO from "@site/src/components/SEO";

<SEO
  title="Using Web3Auth One Key Flow"
  description="Learn how to use Web3Auth One Key Flow to authenticate users with Firebase."
  image="https://web3auth.io/docs/contents/guides/banners/firebase.png"
  slug="/guides/one-key-flow"
/>

This guide will cover the basics of how to set up your Web3Auth SDK as a One Key Flow and Firebase for authenticating your users via a single page.
For this particular guider we are using Firebase as our authentication provider, but <b>you can use any provider you want</b>. This particular user
flow allows a much simpler and more streamlined experience for your users.

## Quick Start

```bash
git clone https://github.com/Web3Auth/examples.git
cd web-core-sdk/one-key-flow/modular-example
npm install
npm run start
```

## How it works?

---

For understanding how the private key generation works using Firebase as a provider, you can refer to this guide
[here](/guides/firebase#how-it-works). This particular guide focuses on how we use Torus libraries to create a better user experience and generate the
private key without redirecting the user.

![Web3Auth Core - One Key Flow](/images/one-key-flow.png)

- Once the social login is successful, depending on if the user has enabled Multi Factor Authentication(MFA) or not, the key is generated.
- If the user has enabled MFA, the private key can be generated simply via Web3Auth Login.
- If the user has not enabled MFA, we use the `@toruslabs/torus.js` library to retrieve the shares of the private key from the Torus nodes and then
  generate the private key.

## Prerequisites

---

<Web3AuthPrerequisites />

- A [Firebase](https://console.firebase.google.com) account to be used as Federated Identity Provider.

- A [Google Developer](https://console.developers.google.com) account to be used as Identity provider for Firebase.

## Setup

---

### Setup your JWT provider

- One key flow will work with any JWT provider. For this particular guide we will use Firebase as our JWT provider.
- You can follow the [Firebase guide](/guides/firebase#setup-your-firebase-project) to setup Firebase.

### Setup your Web3Auth Dashboard

<SetupWeb3AuthDashboard />

Below are the steps to setup Firebase as JWT Provider. The same steps can be followed for any other JWT provider.

- Create a **Verifier** from the **Custom Auth** Section of the [Web3Auth Developer Dashboard](https://dashboard.web3auth.io/) with following
  configuration:

  - Choose a name of your choice for the verifier identifier. `eg. w3a-firebase-verifier`
  - Select environment: `testnet`, `mainnet` or `cyan` as per your requirement.
  - Select `Custom` from the **Login Provider**.
  - Select `Sub` for the **JWT Verifier ID**.
  - Enter `https://www.googleapis.com/service_accounts/v1/jwk/securetoken@system.gserviceaccount.com` as the JWK endpoint for Firebase's idToken.
  - JWT validation fields:
    - iss: `https://securetoken.google.com/<firebase-project-id>`.
    - aud: `<firebase-project-id>`
  - Click on `Create` button to create your verifier. It may take up to 10 minutes to deploy verifier on _testnet_. You'll receive an email once it's
    complete.

  ![Custom Authentication - Create Firebase Verifier](/contents/guides/firebase/firebase-custom-verifier.png)

- You will require the `verifierName` of the newly created verifier and `clientId` of the Plug and Play Project.

## Using the Web3Auth SDK with One Key Flow

---

To use the Web3Auth SDK, you need to add the dependency of the respective platform SDK of Web3Auth to your project. To know more about the available
SDKs, please have a look at this [documentation page](/sdk).

For this guide here, we will be talking through the [Web3Auth Plug and Play Core SDK](/sdk/web/core) and using it with Torus libraries to create an
interface where the user can generate the private key without redirecting the user.

Setting up your base project for using Web3 libraries: If you are starting from scratch, to set up this project locally, you will need to create a
base Web application, where you can install the required dependencies. However, while working with Web3, there are a few base libraries, which need
additional configuration. This is because certain packages are not available in the browser environment, and we need to polyfill them manually.

#### create-react-app

If you are using `create-react-app` version >= 5 you may run into issues building. The issue can be resolved following the instructions below:

#### Solution

- Install `react-app-rewired` and the missing modules into your application

```bash npm2yarn
npm install --save-dev react-app-rewired crypto-browserify stream-browserify assert stream-http https-browserify os-browserify url buffer process
```

- Create `config-overrides.js` in the root of your project folder with the content:

```js
const webpack = require("webpack");

module.exports = function override(config) {
  const fallback = config.resolve.fallback || {};
  Object.assign(fallback, {
    crypto: require.resolve("crypto-browserify"),
    stream: require.resolve("stream-browserify"),
    assert: require.resolve("assert"),
    http: require.resolve("stream-http"),
    https: require.resolve("https-browserify"),
    os: require.resolve("os-browserify"),
    url: require.resolve("url"),
  });
  config.module.rules.unshift({
    test: /\.m?js$/,
    resolve: {
      fullySpecified: false, // disable the behavior
    },
  });
  config.resolve.fallback = fallback;
  config.plugins = (config.plugins || []).concat([
    new webpack.ProvidePlugin({
      process: "process/browser",
      Buffer: ["buffer", "Buffer"],
    }),
  ]);
  config.ignoreWarnings = [/Failed to parse source map/];
  return config;
};
```

- Within `package.json` change the scripts field for start, build and test. Instead of `react-scripts` replace it with `react-app-rewired`

<Tabs
  defaultValue="after"
  values={[
    { label: "before", value: "before" },
    { label: "after", value: "after" },
]}
>

<TabItem value="before">

```typescript
"scripts": {
    "start": "react-scripts start",
    "build": "react-scripts build",
    "test": "react-scripts test",
    "eject": "react-scripts eject"
},
```

</TabItem>

<TabItem value="after">

```typescript
"scripts": {
    "start": "react-app-rewired start",
    "build": "react-app-rewired build",
    "test": "react-app-rewired test",
    "eject": "react-scripts eject"
},
```

</TabItem>

</Tabs>

### Installation

<InstallationWithOneKeyFlowFirebase />

### Initialization

<InitializationIntro />

For this guide, we are focussing on the additional Torus libraries which are used alongside Firebase to create the one key flow.

#### Instantiating Web3Auth

<InstantiationWeb3Auth />

#### Initialising the Openlogin Adapter

```js
const openloginAdapter = new OpenloginAdapter({
  loginSettings: {
    mfaLevel: "default",
  },
  adapterSettings: {
    network: "testnet",
    uxMode: "redirect",
    loginConfig: {
      jwt: {
        name: "Web3Auth One Key Login Flow",
        verifier,
        typeOfLogin: "jwt",
        clientId,
      },
    },
  },
});
```

Here, you need to pass over your Web3Auth `clientId` in the adapterSettings object and your Custom Auth `verifierName` in the loginConfig object.

<InitializationWeb3Auth />

##### Instantiating Torus for One Key Flow

```js
// Importing the packages
import Torus from "@toruslabs/torus.js";
import NodeDetailManager from "@toruslabs/fetch-node-details";
import { subkey } from "@toruslabs/openlogin-subkey";
```

The above packages will help us fetching the node details and creating the private key.

```js
// Configurations for the network
const network = "https://rpc.ankr.com/eth_ropsten",

// Initializing the Torus instance

const torus = new Torus({
  enableOneKey: true,
  network,
});

// Initializing the NodeDetailManager instance for Ropsten Testnet

const nodeDetailManager = new NodeDetailManager({ network, proxyAddress: NodeDetailManager.PROXY_ADDRESS_ROPSTEN });
```

##### Initialize JWT Provider and getting the token id

The following code snippet will initialise Firebase SDK and fetch us the token id. This token id is required later to generate the private key.

```js
// Import the functions you need from the SDK
import { initializeApp } from "firebase/app";

// Your web app's Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyDEfyUmXDhgGWibRUro2EBoX8-TtBKMYyA",
  authDomain: "web3auth-x-firebase-demo-e3332.firebaseapp.com",
  projectId: "web3auth-x-firebase-demo-e3332",
  storageBucket: "web3auth-x-firebase-demo-e3332.appspot.com",
  messagingSenderId: "108145034076",
  appId: "1:108145034076:web:3ff4c0088ec4c311b17799",
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
import { GoogleAuthProvider, getAuth, signInWithPopup, UserCredential } from "firebase/auth";

const signInWithGoogle = async (): Promise<UserCredential> => {
  try {
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const googleProvider = new GoogleAuthProvider();
    const res = await signInWithPopup(auth, googleProvider);
    return res;
  } catch (err) {
    console.error(err);
    throw err;
  }
};

// Calling the signInWithGoogle function to get the token id

const loginRes = await signInWithGoogle();
const idToken = await loginRes.user.getIdToken(true); // this idToken will be passed to web3auth
```

##### Login with Web3Auth

Once initialized, and `idToken` is obtained from **Firebase**, we need to parse the `idToken` to check the parameters of the user.

```js
// creating a parsing token function
const parseToken = (token: any) => {
  const base64Url = idToken?.split(".")[1];
  const base64 = base64Url?.replace("-", "+").replace("_", "/");
  return JSON.parse(window.atob(base64 || ""));
};

const { sub } = parseToken(idToken);

// get details of the node shares on the torus network

const { torusNodeEndpoints, torusNodePub, torusIndexes } = await nodeDetailManager.getNodeDetails({ verifier, verifierId: sub });
const userDetails = await torus.getUserTypeAndAddress(torusNodeEndpoints, torusNodePub, { verifier, verifierId: sub }, true);
```

Now we check if the user has enabled one key login and accordingly make calls to the Torus libraries or Web3Auth SDK.

```js
// checking if the user hasn't enabled one key login
if (userDetails.typeOfUser === "v2" && !userDetails.upgraded) {
  // If Yes, login via Torus Libraries
} else {
  // if NO, login with web3auth
}
```

After checking the user type, we can make the calls to the libraries accordingly.

```js
// if YES, login directly with the torus libraries within your app
const keyDetails = await torus.retrieveShares(torusNodeEndpoints, torusIndexes, verifier, { verifier_id: sub }, idToken, {});
// use the private key to get the provider
const finalPrivKey = subkey(keyDetails.privKey.padStart(64, "0"), Buffer.from(clientId, "base64")).padStart(64, "0");
const ethereumPrivateKeyProvider = new EthereumPrivateKeyProvider({
  config: {
    chainConfig,
  },
});
await ethereumPrivateKeyProvider.setupProvider(finalPrivKey);
```

When connecting using Torus, your `retrieveShares` functions takes various arguements to fetch details from the Torus network. We retrieve the shares
and use `subkey` to create the final private key for the user. Subkey package is required to make sure user will get same key even after enabling mfa.
We then use the `ethereumPrivateKeyProvider` to get the provider.

```js
// if NO, login with web3auth
const web3authProvider = await web3auth.connectTo(WALLET_ADAPTERS.OPENLOGIN, {
  loginProvider: "jwt",
  extraLoginOptions: {
    id_token: idToken,
    verifierIdField: "sub",
    domain: "http://localhost:3000",
  },
});
```

When connecting using Web3Auth, your `connectTo` function takes the arguments for the adapter you want to connect to and the options for the login.
Few major things to note here is the `idToken` and `domain` option in the `extraLoginOptions` object. This is the idToken received from Firebase SDK
and domain is your application domain so that you can be redirected after login from the Web3Auth Plug and Play Core SDK.

### Get the User Profile

Depending upon if the user has enabled MFA or not, we can get the user profile from the provider.

<Tabs
defaultValue="mfa"
values={[
  { label: "MFA Enabled", value: "mfa" },
  { label:"MFA Disabled", value:"mfa-disabled" },
]}
>

<TabItem value="mfa">

```js
const user = await web3auth.getUserInfo();
console.log("User info", user);
```

</TabItem>

<TabItem value="mfa-disabled">

```js
const user = parse(idToken);
console.log("User info", user);
```

</TabItem>

</Tabs>

Depending if the user has enabled MFA or not the functions to get the user profile will be different. If the user has enabled MFA, you can use the
`getUserInfo` function to get the user profile.

### Logout

Logging out your user is as simple as calling the `logout` function.

<Tabs
defaultValue="mfa"
values={[
  { label: "MFA Enabled", value: "mfa" },
  { label:"MFA Disabled", value:"mfa-disabled" },
]}
>

<TabItem value="mfa">

```js
await web3auth.logout();
```

</TabItem>

<TabItem value="mfa-disabled">

```js
// Just Reload the page
window.location.reload();
```

</TabItem>

</Tabs>

### Interacting with Blockchain

<InteractingWithBlockchain />

## Example code

The code for the application we developed in this guide can be found in the
[Web3Auth One Key Flow Example](https://github.com/Web3Auth/examples/tree/main/web-core-sdk/one-key-flow). Check it out and try running it locally
yourself!

## Questions?

Ask us on [Web3Auth's Github Discussion Board](https://web3auth.io/discussions)
